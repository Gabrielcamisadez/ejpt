#+title: Port Scanning & Enumeration
#+author: gabriel

* port scanning techniques
As técnicas de scan definem como o Nmap interage com as portas abertas/fechadas do alvo após a descoberta do host.

** -sS — TCP SYN Scan (Stealth Scan)
É o padrão (se houver privilégio de root) e o mais popular.
*** Funcionamento
- Envia SYN → Recebe SYN/ACK → Envia RST (Não completa o handshake).
- Se receber RST, a porta está fechada.
*** Características
- Rápido: Escaneia milhares de portas por segundo em redes rápidas.
- Furtivo: Como não completa a conexão TCP, muitos logs de aplicação não registram o acesso.
- Eficaz: Diferencia bem entre Open, Closed e Filtered.

** -sT — TCP Connect Scan
O padrão quando o usuário não tem privilégios administrativos.
*** Funcionamento
- Completa o "Three-way Handshake" (SYN -> SYN/ACK -> ACK).
*** Características
- Barulhento: Deixa rastros claros nos logs dos serviços (ex: logs do Apache/Nginx).
- Lento: Leva mais tempo e utiliza mais recursos do que o SYN scan.

** -sU — UDP Scan
Escaneia serviços que utilizam o protocolo UDP.
*** Funcionamento
- Envia pacote UDP para a porta.
- Nenhuma resposta → Open|Filtered.
- ICMP Port Unreachable (Type 3, Code 3) → Closed.
- Resposta UDP → Open.
*** Características
- Extremamente lento devido aos limites de taxa (rate-limit) do ICMP nos kernels.
- Crucial para encontrar DNS (53), SNMP (161), DHCP e serviços de VPN.

** -sV — Service Version Detection
Interroga as portas abertas para determinar exatamente o que está rodando.
*** Funcionamento
- Após o port scan, o Nmap envia "probes" específicos para os serviços.
- Analisa os "banners" e respostas para identificar versão e SO.
*** Características
- Essencial para busca de exploits (ex: saber se é Apache 2.2.22 ou 2.4.50).
- Intensidade: Pode ser ajustada de 0 a 9 com ~--version-intensity~.

* advanced evasion & fingerprinting
Técnicas para obter informações mais profundas ou burlar filtros.

** -O — OS Detection
Tenta identificar o Sistema Operacional através da análise de pacotes TCP/IP.
*** Características
- Analisa opções do TCP, tamanho da janela, TTL e sequência de números.
- Requer pelo menos uma porta aberta e uma fechada para ser preciso.

** -A — Aggressive Scan
Ativa várias opções de uma vez para reconhecimento rápido.
*** O que inclui
- ~-sV~ (Versão), ~-O~ (SO), ~-sC~ (Scripts padrão) e ~--traceroute~.
*** Características
- Extremamente barulhento. Use apenas se a furtividade não for uma prioridade.

** -f e --mtu — Fragmentação de Pacotes

Técnica de evasão que consiste em dividir os cabeçalhos TCP/IP em pedaços menores para confundir Firewalls e Sistemas de Detecção de Intrusão (IDS).

*** Funcionamento

- *-f:* O Nmap divide o cabeçalho em fragmentos de 8 bytes após o cabeçalho IP.
- *-ff:* Divide em fragmentos ainda menores (16 bytes), aumentando a dificuldade de remontagem para o IDS.
- *--mtu [valor]:* Permite definir o tamanho exato da unidade máxima de transmissão (deve ser múltiplo de 8).
  
*** Características

- *Bypass de IDS:* Muitos IDSs antigos ou mal configurados não conseguem remontar todos os fragmentos para analisar a assinatura do ataque antes que eles cheguem ao alvo.
- *Bypass de Firewall:* Alguns firewalls aplicam regras apenas ao primeiro fragmento (que contém as portas), permitindo que os subsequentes passem sem inspeção.
- *Fragilidade:* Kernels modernos e firewalls stateful (como o UFW/iptables com conexões estabelecidas) costumam remontar os pacotes antes da análise, o que pode invalidar a técnica.

*** Uso típico

- *Evasão de assinaturas:* Quando você sabe que há um sensor de rede monitorando por pacotes SYN "padrão".
- *Ambientes Legados:* Muito eficaz contra roteadores e firewalls antigos que não possuem inspeção profunda de pacotes (DPI).

#+begin_src sh
# Fragmentação padrão (8 bytes)
sudo nmap -sS -f -p 21,22,80 172.18.0.2

# Fragmentação personalizada com MTU de 16 bytes
sudo nmap -sS --mtu 16 -p 445 172.18.0.2
#+end_src

**Nota:** Para usar fragmentação, você deve obrigatoriamente usar um scan do tipo Raw (como ~-sS~ ou ~-sU~) e ter privilégios de root.

** -D e -S — Decoy e IP Spoofing (Engodo e Falsificação)

Técnicas avançadas para mascarar a identidade do atacante ou testar regras de confiança baseadas em endereços IP (Whitelists).

*** Funcionamento

- *-D (Decoy):* O Nmap envia pacotes de vários endereços IP falsos junto com o seu IP real. O alvo verá conexões vindas de todos eles simultaneamente.
- *-S (Spoofing):* O Nmap forja o endereço de origem do pacote para ser exatamente o IP de outra máquina.



*** Características

- *Decoy (-D):* - Oculta o seu IP real entre "iscas". 
  - Difulta muito o trabalho do analista de SOC para identificar quem é o verdadeiro atacante.
  - O parâmetro ~ME~ define a posição do seu IP real na lista de iscas.
  - O parâmetro ~RND:[num]~ gera IPs aleatórios.

- *Spoofing (-S):* - Permite "atravessar" firewalls que permitem acesso apenas para IPs específicos (Whitelists).
  - *Limitação:* Você não receberá as respostas (SYN/ACK) de volta, pois elas serão enviadas para o IP falsificado. 
  - Útil para ataques de negação de serviço ou para validar se uma porta está aberta através de análise no Wireshark (vendo o alvo responder ao IP clonado).

*** Uso típico

- *Evasão de Whitelist:* Testar se a porta 445 abre quando o pacote finge vir do IP do servidor de backup.
- *Ofuscação de Logs:* Gerar centenas de logs falsos para que o administrador não saiba qual IP bloquear.

#+begin_src sh
# Decoy Scan: Mistura seu IP com o do admin e outros aleatórios
sudo nmap -Pn -D 172.18.0.4,RND:5,ME 172.18.0.2

# IP Spoofing: Fingindo ser o Admin (172.18.0.4)
# Requer definir a interface (-e) e desativar ping (-Pn)
sudo nmap -Pn -sS -S 172.18.0.4 -e br-7de74f87b4e9 172.18.0.2
#+end_src

**Nota:** No Spoofing, para saber se a porta está aberta, você deve monitorar o tráfego com o Wireshark e procurar por respostas do alvo destinadas ao IP que você falsificou.
** -sC — Default Script Scan


Equivale a ~--script=default~. Roda scripts seguros e úteis para enumeração.
*** Exemplos comuns de uso
- Identificar banners, chaves SSH, títulos de páginas web e domínios SMB.

* performance & optimization
Ajustes para ganhar tempo e precisão em diferentes infraestruturas.

** timing templates (-T)
- *-T0 (Paranoid):* Serializado, espera 5 min entre pacotes. Para fugir de IDSs.
- *-T1 (Sneaky):* Muito lento, para scans de longa duração.
- *-T2 (Polite):* Consome menos largura de banda, 10x mais lento que o T3.
- *-T3 (Normal):* O padrão do Nmap.
- *-T4 (Aggressive):* O ideal para CTFs e Redes Locais. Assume rede estável.
- *-T5 (Insane):* Extremamente rápido. Pode perder pacotes ou derrubar serviços.

** parallelism & rate limiting
Controle fino da carga enviada à rede.
#+begin_src sh
--min-parallelism [num] # Define o mínimo de operações simultâneas.
--max-rate [pacotes/s]  # Limita a taxa de envio (excelente para evitar crash em serviços).
--min-rate [pacotes/s]  # Garante uma velocidade mínima de scan.
#+end_src

** --host-timeout e --scan-delay — Evasão e Estabilidade

Parâmetros críticos para manipular o tempo do scan, permitindo burlar sistemas de detecção (IDS) ou evitar sobrecarga em dispositivos sensíveis.

*** Funcionamento

- *--host-timeout:* Define o tempo máximo que o Nmap dedicará a um único alvo antes de desistir dele.
- *--scan-delay:* Insere uma pausa obrigatória entre cada probe (pacote) enviado.



*** Características

- *Evasão de IDS/IPS:* O --scan-delay é uma das técnicas mais eficazes para passar por sistemas que bloqueiam IPs baseados em "muitos pacotes em pouco tempo" (Threshold).
- *Performance em Redes Lentas:* O --host-timeout evita que o scan fique "travado" em um único host que está respondendo muito lentamente ou que possui um firewall que causa timeouts propositais.
- *Furtividade:* Aumentar o delay torna o scan quase imperceptível em análises de tráfego, pois os pacotes se misturam ao ruído normal da rede.

*** Uso típico

- *Redes com IPS ativo:* Usar ~--scan-delay 5s~ ou maior para não disparar alertas de port scanning.
- *Scans em larga escala:* Usar ~--host-timeout 3m~ em uma sub-rede /24 para garantir que hosts problemáticos não atrasem o mapeamento de toda a rede.

#+begin_src sh
# Exemplo de scan ultra furtivo para evasão de IDS
sudo nmap -sS -p 22,80,445 --scan-delay 10s --max-retries 1 172.18.0.2

# Exemplo de otimização para redes grandes e instáveis
sudo nmap -F -T4 --host-timeout 30s 172.18.0.0/24
#+end_src


* useful output formats
Guardar os resultados de forma organizada para relatórios e ferramentas.

#+begin_src sh
-oN scan.txt    # Normal: O formato que vemos no terminal.
-oG scan.gnmap  # Grepable: Fácil de manipular com grep/awk/cut.
-oX scan.xml    # XML: Para importar no Zenmap, Metasploit ou Ivy.
-oA full_output # Salva nos três formatos acima de uma só vez.
#+end_src

* practical examples for lab
#+begin_src sh
# Scan rápido de todas as portas (Full Scan) com T4
sudo nmap -sS -p- -T4 172.18.0.2

# Enumeração profunda de um alvo específico descoberto
sudo nmap -sS -sV -sC -O -p 22,80,445 172.18.0.2

# Scan UDP focado em serviços comuns
sudo nmap -sU -F -T4 172.18.0.2
#+end_src

